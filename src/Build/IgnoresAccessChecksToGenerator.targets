<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <_IACTG_TFM Condition="'$(MSBuildRuntimeType)' == 'Core'">netstandard1.3</_IACTG_TFM>
    <_IACTG_TFM Condition="'$(MSBuildRuntimeType)' != 'Core'">net46</_IACTG_TFM>
    <_IACTG_TaskAssembly>$(MSBuildThisFileDirectory)..\tools\$(_IACTG_TFM)\IgnoresAccessChecksToGenerator.Tasks.dll</_IACTG_TaskAssembly>
  </PropertyGroup>
  
  <UsingTask AssemblyFile="$(_IACTG_TaskAssembly)" TaskName="IgnoresAccessChecksToGenerator.Tasks.PublicizeInternals" />

  <Target Name="IgnoresAccessChecksToGenerator" AfterTargets="ResolveReferences">
    <PropertyGroup>
      <_IACTG_UseReferenceAssemblies>true</_IACTG_UseReferenceAssemblies>
      <_IACTG_UseReferenceAssemblies Condition="'$(CompileUsingReferenceAssemblies)' == 'false'">false</_IACTG_UseReferenceAssemblies>
      <_CompileTargetNameForLocalType>_CompileTemporaryAssemblyWithIgnoreAccessChecks</_CompileTargetNameForLocalType>
    </PropertyGroup>

    <PublicizeInternals 
      SourceReferences="@(ReferencePath)" 
      AssemblyNames="$(InternalsAssemblyNames)" 
      UseReferenceAssemblies="$(_IACTG_UseReferenceAssemblies)"
      OutputPath="$(IntermediateOutputPath)">
      <Output ItemName="_IACTG_TargetReferences" TaskParameter="TargetReferences" />
      <Output ItemName="_IACTG_RemovedReferences" TaskParameter="RemovedReferences" />
      <Output ItemName="Compile" TaskParameter="GeneratedCodeFiles" />
    </PublicizeInternals>

  </Target>

  <Target Name="IgnoresAccessChecks_BeforeMarkupCompilePass1" BeforeTargets="CoreCompile" >

    <ItemGroup>
      <ReferencePath Remove="@(_IACTG_RemovedReferences)" />
      <ReferencePath Include="@(_IACTG_TargetReferences)" />
    </ItemGroup>
  </Target>

  <Target Name="IgnoresAccessChecks_BeforeMarkupCompilePass2" BeforeTargets="MarkupCompilePass2ForMainAssembly" >
    <ItemGroup>
      <ReferencePath Remove="@(_IACTG_RemovedReferences)" />

      <ReferencePath Include="@(_IACTG_TargetReferences -> %(ReferenceAssembly))" 
        Condition="'%(_IACTG_TargetReferences.ReferenceAssembly)' != '' AND '$(_IACTG_UseReferenceAssemblies)' == 'true'" />
      <ReferencePath Include="@(_IACTG_TargetReferences)" />
    </ItemGroup>
  </Target>

</Project>